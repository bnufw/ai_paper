# Design: add-paper-notes

## 架构概览

```
┌─────────────────────────────────────────────────────────────┐
│                        UI Layer                             │
│  ┌─────────────────┐    ┌─────────────────────────────┐    │
│  │  NoteTabSwitch  │    │      NoteEditor             │    │
│  │  (论文/笔记切换) │    │  (Markdown编辑器+预览)      │    │
│  └────────┬────────┘    └──────────────┬──────────────┘    │
└───────────┼─────────────────────────────┼──────────────────┘
            │                             │
┌───────────▼─────────────────────────────▼──────────────────┐
│                      Service Layer                          │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                   noteService.ts                     │   │
│  │  - generateNote(paperId): 调用AI生成笔记             │   │
│  │  - saveNote(paperId, content): 保存笔记              │   │
│  │  - loadNote(paperId): 加载笔记                       │   │
│  │  - hasNote(paperId): 检查笔记是否存在                │   │
│  └──────────────┬──────────────────────┬───────────────┘   │
└─────────────────┼──────────────────────┼───────────────────┘
                  │                      │
    ┌─────────────▼─────────┐    ┌───────▼────────┐
    │   geminiClient.ts     │    │ paperStorage.ts│
    │   (AI 笔记生成)        │    │ (文件读写)     │
    └───────────────────────┘    └────────────────┘
```

## 数据模型

### 存储结构

笔记存储为 `note.md` 文件，与论文其他文件同级：

```
{存储根目录}/
└── {分组名}/
    └── {论文名}_{时间戳}/
        ├── source.pdf      # PDF原文
        ├── paper.md        # 论文Markdown
        ├── note.md         # 笔记文件 (新增)
        └── images/         # 图片目录
```

### 笔记状态

```typescript
type NoteStatus = 
  | 'none'        // 笔记不存在
  | 'generating'  // 正在生成中
  | 'ready'       // 笔记已就绪
  | 'error'       // 生成失败
```

## 核心流程

### 1. 笔记生成流程

```
用户点击"生成笔记" 
    ↓
检查论文是否有 localPath
    ↓ (无)
显示提示：仅支持新版论文
    ↓ (有)
读取 paper.md 内容
    ↓
调用 Gemini API（使用 prompts/note.md 提示词）
    ↓ (流式输出)
实时显示生成进度
    ↓
保存到 note.md
    ↓
切换到笔记查看模式
```

### 2. 笔记编辑流程

```
用户切换到笔记标签页
    ↓
加载 note.md 内容
    ↓ (不存在)
显示空状态 + "生成笔记"按钮
    ↓ (存在)
显示 Markdown 编辑器
    ↓
用户编辑内容
    ↓
自动保存 / 手动保存
```

## 组件设计

### 新增组件

| 组件 | 位置 | 职责 |
|------|------|------|
| `NotePanel.tsx` | `components/note/` | 笔记面板容器，管理编辑/预览状态 |
| `NoteEditor.tsx` | `components/note/` | Markdown 编辑器组件 |
| `NoteEmptyState.tsx` | `components/note/` | 笔记不存在时的空状态提示 |

### 修改组件

| 组件 | 修改内容 |
|------|----------|
| `App.tsx` | 添加笔记标签页路由状态 |
| `MarkdownViewer.tsx` | 复用现有组件渲染笔记预览 |

## 服务设计

### noteService.ts

```typescript
// 核心接口（伪代码）
interface NoteService {
  // 检查笔记是否存在
  hasNote(paperId: number): Promise<boolean>
  
  // 加载笔记内容
  loadNote(paperId: number): Promise<string | null>
  
  // 保存笔记内容
  saveNote(paperId: number, content: string): Promise<void>
  
  // 生成笔记（调用AI）
  generateNote(
    paperId: number,
    onStream?: (text: string) => void
  ): Promise<string>
}
```

### AI 调用设计

复用现有 `geminiClient.ts` 的模式，但使用不同的提示词：

1. **系统提示词**：读取 `prompts/note.md` 文件内容
2. **用户输入**：论文 Markdown 全文
3. **输出**：结构化的论文笔记

## UI/UX 设计

### 标签页切换

在论文阅读区域顶部添加标签切换：

```
┌─────────────────────────────────────────┐
│  [📄 论文]  [📝 笔记]                    │
├─────────────────────────────────────────┤
│                                         │
│         内容区域                         │
│                                         │
└─────────────────────────────────────────┘
```

### 笔记编辑界面

```
┌─────────────────────────────────────────┐
│  [编辑] [预览]              [保存]      │
├─────────────────────────────────────────┤
│                                         │
│  Markdown 编辑器 / 预览区域              │
│                                         │
└─────────────────────────────────────────┘
```

### 空状态

```
┌─────────────────────────────────────────┐
│                                         │
│           📝                            │
│     暂无笔记                            │
│                                         │
│     [✨ AI 生成笔记]                    │
│                                         │
└─────────────────────────────────────────┘
```

## 技术决策

### 为什么使用文件存储而非数据库？

1. **一致性**：与论文其他文件（PDF、Markdown）保持相同的存储方式
2. **便携性**：用户可以直接在文件管理器中查看和编辑笔记
3. **简洁性**：无需数据库迁移，减少复杂度

### 为什么只支持新版论文？

旧版论文（无 `localPath`）存储在 IndexedDB 中，要支持笔记需要：
- 新增数据库表和迁移逻辑
- 维护两套存储代码

考虑到：
1. 新版本是推荐的存储方式
2. 旧论文可以重新上传以获得新版存储
3. 保持实现简洁

因此第一版只支持新版论文。

### Markdown 编辑器选型

使用原生 `<textarea>` + 现有 `MarkdownViewer` 组件：
- 无需引入新依赖
- 复用现有渲染逻辑（KaTeX、Mermaid、代码高亮）
- 满足基本编辑需求

## 兼容性考虑

- 仅支持有 `localPath` 的论文
- 对于旧论文，笔记标签页显示升级提示
